<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title> ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« </title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css" />
<link rel="stylesheet" href="styles.css" />

</head>

<body>
<div id="container">
    <div id="leftContainer">
        <textarea id="editor">//ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è¨˜è¿°</textarea>

        <button id="runButton">ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ</button>

        <div id="console"></div>
    </div>

    <div id="rightContainer">
        <div id="taskContainer">
            <div id="taskButtons">
                <label for="taskSelect">èª²é¡Œé¸æŠ:</label>
                <select id="taskSelect">
                    <option value="">èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
                <input type="number" id="taskNumber" placeholder="èª²é¡Œç•ªå· (1-111)" min="1" max="111">
                <button id="loadTaskButton">èª²é¡Œèª­ã¿è¾¼ã¿</button>
            </div>

            <div id="taskContent">èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>

        <div id="levelContainer">
            <div id="levelButtons">
                <button data-task="0">ğŸ¤– AI Help - ã‚³ãƒ¼ãƒ‰è©•ä¾¡</button>
            </div>
            <div id="levelContent">
            <div style="text-align:center; color:#666; padding:20px;">
                <p>ğŸ“ <strong>ä½¿ã„æ–¹</strong></p>
                <p>1. èª²é¡Œã‚’é¸æŠ</p>
                <p>2. ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°</p>
                <p>3. ä¸Šã®ãƒœã‚¿ãƒ³ã§AIè©•ä¾¡ã‚’å–å¾—</p>
                <br>
                <p style="font-size:12px;">AIãŒã‚³ãƒ¼ãƒ‰ã®å“è³ªã€æ­£ç¢ºæ€§ã€æ”¹å–„ç‚¹ã‚’åˆ†æã—ã¦è©³ç´°ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã—ã¾ã™</p>
                <hr style="margin: 15px 0;">
                <div style="font-size:12px;">
                    <strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</strong><br>
                    <button onclick="manualTestAPI()" style="margin:5px; padding:3px 8px; font-size:11px;">APIæ‰‹å‹•ãƒ†ã‚¹ãƒˆ</button>
                    <button onclick="showTasksData()" style="margin:5px; padding:3px 8px; font-size:11px;">ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
                    <button onclick="testOpenAI()" style="margin:5px; padding:3px 8px; font-size:11px;">AIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/clike/clike.min.js"></script>
<script>
    const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: "text/x-csrc",
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
    });
    const console = document.getElementById('console');
    const runButton = document.getElementById('runButton');
    const levelContent = document.getElementById('levelContent');
    
    // å®‰å…¨ãªãƒ­ã‚°é–¢æ•°
    function safeLog(message, data = '') {
        try {
            if (typeof console !== 'undefined' && console.log) {
                console.log(message, data);
            }
        } catch (e) {
            // console ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        }
    }
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showDebugMessage(message) {
        const debugDiv = document.getElementById('debugMessage') || (() => {
            const div = document.createElement('div');
            div.id = 'debugMessage';
            div.style.cssText = 'position:fixed;top:10px;right:10px;background:#333;color:#fff;padding:10px;font-size:12px;max-width:300px;z-index:9999;border-radius:4px;';
            document.body.appendChild(div);
            return div;
        })();
        debugDiv.innerHTML = message + '<br>' + (debugDiv.innerHTML || '');
        setTimeout(() => debugDiv.style.display = 'none', 10000); // 10ç§’å¾Œã«éè¡¨ç¤º
    }
    
    let currentTaskId = null;
    let currentTaskDescription = '';
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
    window.manualTestAPI = function() {
        safeLog('=== APIæ‰‹å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        showDebugMessage('ğŸ”§ APIæ‰‹å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        fetch('/api/tasks')
            .then(response => {
                safeLog('Response status:', response.status);
                safeLog('Response ok:', response.ok);
                showDebugMessage(`APIå¿œç­”: ${response.status} ${response.ok ? 'OK' : 'NG'}`);
                return response.json();
            })
            .then(data => {
                safeLog('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                const taskCount = data.tasks ? data.tasks.length : 0;
                showDebugMessage(`âœ… APIæ­£å¸¸: ${taskCount}å€‹ã®èª²é¡Œ`);
                alert(`APIå¿œç­”æ­£å¸¸: ${taskCount}å€‹ã®èª²é¡Œ`);
            })
            .catch(error => {
                safeLog('APIã‚¨ãƒ©ãƒ¼:', error);
                showDebugMessage(`âŒ APIã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert('APIã‚¨ãƒ©ãƒ¼: ' + error.message);
            });
    };
    
    window.showTasksData = function() {
        safeLog('=== tasksDataç¢ºèª ===');
        
        const currentTasksData = tasksData || window.tasksData;
        safeLog('tasksData:', currentTasksData);
        
        let message = '';
        if (currentTasksData && currentTasksData.tasks) {
            message = `tasksDataç¢ºèª: ${currentTasksData.tasks.length}å€‹ã®èª²é¡ŒãŒèª­ã¿è¾¼ã¿æ¸ˆã¿`;
            message += `\næœ€åˆã®5ã¤ã®èª²é¡Œ: ${currentTasksData.tasks.slice(0, 5).map(t => t.title).join(', ')}`;
            showDebugMessage(`âœ… ${message}`);
        } else if (currentTasksData) {
            message = 'tasksDataã¯å­˜åœ¨ã—ã¾ã™ãŒã€tasksãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“';
            message += `\nã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº«: ${Object.keys(currentTasksData).join(', ')}`;
            showDebugMessage(`âš ï¸ ${message}`);
        } else {
            message = 'tasksDataãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“';
            showDebugMessage(`âŒ ${message}`);
        }
        
        alert(message);
    };
    
    window.testOpenAI = function() {
        safeLog('=== OpenAIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        showDebugMessage('ğŸ¤– OpenAIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        fetch('/api/test-openai')
            .then(response => response.json())
            .then(data => {
                safeLog('OpenAI ãƒ†ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                if (data.status === 'success') {
                    showDebugMessage('âœ… OpenAIæ¥ç¶šæˆåŠŸ');
                    alert(`OpenAI APIæ¥ç¶šæˆåŠŸ!\n${data.message}`);
                } else {
                    showDebugMessage(`âŒ OpenAIæ¥ç¶šå¤±æ•—: ${data.message}`);
                    alert(`OpenAI APIæ¥ç¶šå¤±æ•—:\n${data.message}\nã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${data.error_type || 'Unknown'}`);
                }
            })
            .catch(error => {
                safeLog('OpenAI ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showDebugMessage(`âŒ OpenAIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert('OpenAIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            });
    };
    
    // loadTasksé–¢æ•°ã‚‚ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«
    window.loadTasks = async function() {
        try {
            safeLog('èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...');
            showDebugMessage('ğŸ“¡ èª²é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
            
            const response = await fetch('/api/tasks');
            
            safeLog('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                safeLog('API Error:', errorText);
                showDebugMessage('âŒ API Error: ' + response.status);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            safeLog('å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);
            safeLog('èª²é¡Œæ•°:', data.tasks ? data.tasks.length : 'tasksãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            
            if (!data.tasks || !Array.isArray(data.tasks)) {
                showDebugMessage('âŒ ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼');
                throw new Error('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœŸå¾…ã•ã‚Œã‚‹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
            }
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ç¢ºå®Ÿã«ä»£å…¥
            window.tasksData = data;
            tasksData = data;
            
            safeLog('tasksDataè¨­å®šå®Œäº†:', tasksData);
            showDebugMessage('ğŸ“‹ tasksDataè¨­å®š: ' + data.tasks.length + 'ä»¶');
            
            populateTaskSelect();
            safeLog('èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å®Œäº†');
            showDebugMessage('âœ… èª²é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ' + data.tasks.length + 'ä»¶');
        } catch (error) {
            safeLog('èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error.message);
            showDebugMessage('âŒ èª²é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
            
            document.getElementById('taskContent').innerHTML = `
                <div style="color:red; padding: 10px; border: 1px solid red; border-radius: 4px;">
                    <h3>âŒ èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                    <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
                    <details style="margin-top: 10px;">
                        <summary>è©³ç´°æƒ…å ±</summary>
                        <pre style="background: #f0f0f0; padding: 8px; margin-top: 5px; white-space: pre-wrap;">${error.stack || 'ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãªã—'}</pre>
                    </details>
                    <button onclick="loadTasks()" style="margin-top: 10px; padding: 5px 10px;">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
                </div>
            `;
        }
    };
    
    // ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆWandbox APIã®ã¿ï¼‰
    runButton.addEventListener('click', async () => {
        const code = editor.getValue();
        console.textContent = 'å®Ÿè¡Œä¸­\n';

        try {
            const compileResponse = await fetch('https://wandbox.org/api/compile.json', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    code: code,
                    compiler: 'gcc-head',
                    options: '-std=c11',
                    stdin: ''
                })
            });
            
            const data = await compileResponse.json();
            
            if(data.compiler_error) {
                console.textContent = 'ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼\n' + data.compiler_error;
            } else if(data.program_error) {
                console.textContent = 'å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼\n' + data.program_error;
            } else {
                console.textContent = 'å®Ÿè¡Œçµæœ\n' + data.program_output;
            }
            
            showDebugMessage('âœ… ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œå®Œäº†');
        } catch (err) {
            console.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼\n';
            showDebugMessage('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
        }
    });
    
    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayFeedback(feedback) {
        const levelImages = {
            1: 'ğŸ”´', 2: 'ğŸŸ ', 3: 'ğŸŸ¡', 4: 'ğŸŸ¢', 5: 'ğŸŒŸ'
        };
        
        const correctIcon = feedback.is_correct ? 'âœ…' : 'âŒ';
        
        levelContent.innerHTML = `
            <div style="padding: 10px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <h3>è©•ä¾¡çµæœ ${levelImages[feedback.level]} ãƒ¬ãƒ™ãƒ«${feedback.level}</h3>
                    <div style="font-size: 18px;">${correctIcon} èª²é¡Œé”æˆ: ${feedback.is_correct ? 'æˆåŠŸ' : 'æœªå®Œäº†'}</div>
                    <div>ç·åˆã‚¹ã‚³ã‚¢: ${feedback.overall_score}/5</div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <h4>ğŸ“ è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
                    <p style="background: #f0f0f0; padding: 8px; border-radius: 4px; margin: 0;">${feedback.detailed_feedback}</p>
                </div>
                
                ${feedback.strengths.length > 0 ? `
                <div style="margin-bottom: 10px;">
                    <h4>ğŸ‘ è‰¯ã„ç‚¹</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${feedback.strengths.map(s => `<li>${s}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${feedback.improvements.length > 0 ? `
                <div style="margin-bottom: 10px;">
                    <h4>ğŸ”§ æ”¹å–„ç‚¹</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${feedback.improvements.map(i => `<li>${i}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                ${feedback.hints.length > 0 ? `
                <div style="margin-bottom: 10px;">
                    <h4>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h4>
                    <ul style="margin: 0; padding-left: 20px;">
                        ${feedback.hints.map(h => `<li>${h}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
                
                <div>
                    <h4>ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h4>
                    <p style="background: #e8f5e8; padding: 8px; border-radius: 4px; margin: 0;">${feedback.next_steps}</p>
                </div>
            </div>
        `;
    }

    // èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
    let tasksData = {};
    
    // èª²é¡Œé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    function populateTaskSelect() {
        safeLog('populateTaskSelecté–‹å§‹');
        showDebugMessage('ğŸ“‹ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ§‹ç¯‰é–‹å§‹');
        
        const taskSelect = document.getElementById('taskSelect');
        
        if (!taskSelect) {
            safeLog('taskSelectã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            showDebugMessage('âŒ taskSelectã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãªã—');
            return;
        }
        
        // ã‚ˆã‚Šå³å¯†ãªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
        const currentTasksData = tasksData || window.tasksData;
        
        if (!currentTasksData) {
            safeLog('tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            showDebugMessage('âŒ tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            taskSelect.innerHTML = '<option value="">èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>';
            return;
        }
        
        if (!currentTasksData.tasks || !Array.isArray(currentTasksData.tasks)) {
            safeLog('tasksData.tasksãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', currentTasksData);
            showDebugMessage('âŒ tasksData.tasksãŒç„¡åŠ¹');
            taskSelect.innerHTML = '<option value="">èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒç„¡åŠ¹</option>';
            return;
        }
        
        taskSelect.innerHTML = '<option value="">èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        let addedCount = 0;
        currentTasksData.tasks.forEach((task, index) => {
            if (task && task.id && task.title) {
                safeLog(`èª²é¡Œ${index + 1}ã‚’è¿½åŠ :`, task);
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.title;
                taskSelect.appendChild(option);
                addedCount++;
            } else {
                safeLog('ç„¡åŠ¹ãªèª²é¡Œãƒ‡ãƒ¼ã‚¿:', task);
            }
        });
        
        safeLog(`åˆè¨ˆ${addedCount}å€‹ã®èª²é¡Œã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¿½åŠ ã—ã¾ã—ãŸ`);
        showDebugMessage(`ğŸ“‹ ${addedCount}å€‹ã®èª²é¡Œã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¿½åŠ `);
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
        document.getElementById('taskContent').innerHTML = `
            <div style="color: green; padding: 10px;">
                âœ… ${addedCount}å€‹ã®èª²é¡ŒãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ<br>
                ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„
            </div>
        `;
    }
    
    // èª²é¡Œã‚’è¡¨ç¤ºã™ã‚‹
    function displayTask(taskId) {
        safeLog('displayTaskå‘¼ã³å‡ºã—:', taskId);
        showDebugMessage('ğŸ“ èª²é¡Œ' + taskId + 'è¡¨ç¤ºé–‹å§‹');
        
        // ã‚ˆã‚Šå³å¯†ãªå­˜åœ¨ãƒã‚§ãƒƒã‚¯
        const currentTasksData = tasksData || window.tasksData;
        
        if (!currentTasksData) {
            safeLog('tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            showDebugMessage('âš ï¸ tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“ - èª­ã¿è¾¼ã¿é–‹å§‹');
            document.getElementById('taskContent').innerHTML = `
                <div style="color:orange; padding: 10px;">
                    âš ï¸ èª²é¡Œãƒ‡ãƒ¼ã‚¿ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“<br>
                    <button onclick="loadTasks()" style="margin-top: 5px;">èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
                </div>
            `;
            // è‡ªå‹•ã§èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
            window.loadTasks();
            return;
        }
        
        if (!currentTasksData.tasks || !Array.isArray(currentTasksData.tasks)) {
            safeLog('tasksData.tasksãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', currentTasksData);
            showDebugMessage('âš ï¸ tasksData.tasksãŒç„¡åŠ¹');
            document.getElementById('taskContent').innerHTML = `
                <div style="color:orange; padding: 10px;">
                    âš ï¸ èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒç„¡åŠ¹ã§ã™<br>
                    <button onclick="loadTasks()" style="margin-top: 5px;">å†èª­ã¿è¾¼ã¿</button>
                </div>
            `;
            return;
        }
        
        const task = currentTasksData.tasks.find(t => t.id == taskId);
        const taskContent = document.getElementById('taskContent');
        
        if (task) {
            currentTaskId = task.id;
            currentTaskDescription = task.description;
            
            taskContent.innerHTML = `
                <h3>${task.title}</h3>
                <p>${task.description}</p>
            `;
            safeLog('èª²é¡Œè¡¨ç¤ºå®Œäº†:', task.title);
            showDebugMessage(`âœ… èª²é¡Œ${taskId}è¡¨ç¤ºå®Œäº†`);
        } else {
            taskContent.innerHTML = `
                <div style="color:red; padding: 10px;">
                    âŒ èª²é¡Œ${taskId}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>
                    åˆ©ç”¨å¯èƒ½ãªèª²é¡Œ: 1ã€œ${currentTasksData.tasks.length}<br>
                    <small>åˆ©ç”¨å¯èƒ½ãªèª²é¡ŒID: ${currentTasksData.tasks.map(t => t.id).slice(0, 10).join(', ')}...</small>
                </div>
            `;
            currentTaskId = null;
            currentTaskDescription = '';
            safeLog('èª²é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', taskId);
            showDebugMessage(`âŒ èª²é¡Œ${taskId}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        }
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.addEventListener('DOMContentLoaded', () => {
        window.loadTasks();
        
        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§ã®èª²é¡Œé¸æŠ
        document.getElementById('taskSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                displayTask(e.target.value);
                document.getElementById('taskNumber').value = e.target.value;
            }
        });
        
        // èª²é¡Œç•ªå·å…¥åŠ›ã§ã®èª²é¡Œé¸æŠ
        document.getElementById('taskNumber').addEventListener('input', (e) => {
            const taskId = e.target.value;
            if (taskId >= 1 && taskId <= 111) {
                document.getElementById('taskSelect').value = taskId;
                if (tasksData.tasks && tasksData.tasks.find(t => t.id == taskId)) {
                    displayTask(taskId);
                }
            }
        });
        
        // èª²é¡Œèª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
        document.getElementById('loadTaskButton').addEventListener('click', () => {
            const taskId = document.getElementById('taskNumber').value;
            if (taskId >= 1 && taskId <= 111) {
                displayTask(taskId);
                document.getElementById('taskSelect').value = taskId;
            } else {
                alert('1ã‹ã‚‰111ã®é–“ã®èª²é¡Œç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        });
        
        // AI Helpãƒœã‚¿ãƒ³
        const aiHelpButton = document.querySelector('#levelButtons button[data-task="0"]');
        if (aiHelpButton) {
            aiHelpButton.addEventListener('click', async () => {
                const code = editor.getValue();
                
                if (!currentTaskId || !currentTaskDescription) {
                    levelContent.innerHTML = '<div style="color:orange;">ã¾ãšèª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                    showDebugMessage('âš ï¸ èª²é¡Œæœªé¸æŠ');
                    return;
                }
                
                if (!code.trim() || code.trim() === '//ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è¨˜è¿°') {
                    levelContent.innerHTML = '<div style="color:orange;">ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ã‹ã‚‰AI Helpã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>';
                    showDebugMessage('âš ï¸ ã‚³ãƒ¼ãƒ‰æœªè¨˜è¿°');
                    return;
                }
                
                levelContent.innerHTML = '<div style="text-align:center;">ğŸ¤– AIãŒã‚³ãƒ¼ãƒ‰ã‚’è©•ä¾¡ä¸­...</div>';
                showDebugMessage('ğŸ¤– AIè©•ä¾¡é–‹å§‹');
                
                try {
                    const feedbackResponse = await fetch('/api/evaluate-code', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            code: code,
                            task_id: currentTaskId,
                            task_description: currentTaskDescription
                        })
                    });
                    
                    const feedbackData = await feedbackResponse.json();
                    
                    if (feedbackData.success) {
                        displayFeedback(feedbackData.feedback);
                        showDebugMessage('âœ… AIè©•ä¾¡å®Œäº†');
                    } else {
                        levelContent.innerHTML = '<div style="color:red;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼: ' + (feedbackData.error || 'Unknown error') + '</div>';
                        showDebugMessage('âŒ AIè©•ä¾¡ã‚¨ãƒ©ãƒ¼');
                    }
                } catch (error) {
                    levelContent.innerHTML = '<div style="color:red;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
                    showDebugMessage('âŒ AIè©•ä¾¡ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            });
        }
    });
</script>
</body>

</html>