<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>æ®µéšçš„å­¦ç¿’æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ </title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css" />
<link rel="stylesheet" href="styles.css" />

<style>
/* æ®µéšçš„å­¦ç¿’ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
.phase-progress {
    background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 2px solid #2196F3;
}

.phase-indicator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.phase-step {
    flex: 1;
    text-align: center;
    padding: 8px;
    margin: 0 2px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.phase-step.active {
    background-color: #4CAF50;
    color: white;
    transform: scale(1.05);
}

.phase-step.completed {
    background-color: #2196F3;
    color: white;
}

.phase-step.pending {
    background-color: #f0f0f0;
    color: #666;
}

.stage-detail {
    background: white;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.completion-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.completion-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.5s ease;
}

.analysis-section {
    margin: 15px 0;
    padding: 12px;
    border-radius: 6px;
    border-left: 4px solid #2196F3;
}

.analysis-section h4 {
    margin: 0 0 8px 0;
    color: #1976D2;
}

.analysis-section.strengths {
    background-color: #e8f5e8;
    border-left-color: #4CAF50;
}

.analysis-section.improvements {
    background-color: #fff3e0;
    border-left-color: #FF9800;
}

.analysis-section.next-steps {
    background-color: #e3f2fd;
    border-left-color: #2196F3;
}

.analysis-section.encouragement {
    background-color: #f3e5f5;
    border-left-color: #9C27B0;
}

.progressive-learning-button {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    width: 100%;
    margin-bottom: 10px;
    transition: transform 0.2s ease;
}

.progressive-learning-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

</head>

<body>
<div id="container">
    <div id="leftContainer">
        <textarea id="editor">//ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è¨˜è¿°</textarea>

        <button id="runButton">ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ</button>

        <div id="console"></div>
    </div>

    <div id="rightContainer">
        <!-- å…ƒã®èª²é¡Œé¸æŠéƒ¨åˆ†ã‚’ãã®ã¾ã¾ä¿æŒ -->
        <div id="taskContainer">
            <div id="taskButtons">
                <label for="taskSelect">èª²é¡Œé¸æŠ:</label>
                <select id="taskSelect">
                    <option value="">èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>

            <div id="taskContent">èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>

        <!-- æ®µéšçš„å­¦ç¿’é€²æ—è¡¨ç¤ºï¼ˆæ–°æ©Ÿèƒ½ï¼‰ -->
        <div id="phase-progress-container" class="phase-progress" style="display: none;">
            <div class="phase-indicator">
                <div class="phase-step pending" data-phase="phase1">
                    <div>â‘ </div>
                    <div>èª²é¡Œç†è§£</div>
                </div>
                <div class="phase-step pending" data-phase="phase2to4">
                    <div>â‘¡-â‘£</div>
                    <div>æ§‹æƒ³ãƒ»å®Ÿè£…</div>
                </div>
                <div class="phase-step pending" data-phase="phase5">
                    <div>â‘¤</div>
                    <div>æ¤œè¨¼</div>
                </div>
            </div>
            
            <div id="stage-detail" class="stage-detail" style="display: none;">
                <div id="current-stage-info"></div>
                <div class="completion-bar">
                    <div id="completion-fill" class="completion-fill" style="width: 0%"></div>
                </div>
                <div id="completion-text">0% å®Œæˆ</div>
            </div>
        </div>

        <!-- levelContainer ã¯å…ƒã®ã¾ã¾ã€ãƒœã‚¿ãƒ³ã®ã¿å¤‰æ›´ -->
        <div id="levelContainer">
            <div id="levelButtons">
                <button class="progressive-learning-button" data-task="0">ğŸ¤– AIæ®µéšçš„å­¦ç¿’æ”¯æ´ - ã‚³ãƒ¼ãƒ‰åˆ†æ</button>
            </div>
            <div id="levelContent">
            <div style="text-align:center; color:#666; padding:20px;">
                <p>ğŸ“ <strong>æ®µéšçš„å­¦ç¿’æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ </strong></p>
                <p>1. èª²é¡Œã‚’é¸æŠ</p>
                <p>2. ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°</p>
                <p>3. AIæ®µéšçš„å­¦ç¿’æ”¯æ´ãƒœã‚¿ãƒ³ã§åˆ†æã‚’å–å¾—</p>
                <br>
                <p style="font-size:12px;">AIãŒå­¦ç¿’æ®µéšã‚’åˆ¤å®šã—ã€é©åˆ‡ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æä¾›ã—ã¾ã™</p>
                <hr style="margin: 15px 0;">
                <div style="font-size:12px;">
                    <strong>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</strong><br>
                    <button onclick="manualTestAPI()" style="margin:5px; padding:3px 8px; font-size:11px;">APIæ‰‹å‹•ãƒ†ã‚¹ãƒˆ</button>
                    <button onclick="showTasksData()" style="margin:5px; padding:3px 8px; font-size:11px;">ãƒ‡ãƒ¼ã‚¿ç¢ºèª</button>
                    <button onclick="testOpenAI()" style="margin:5px; padding:3px 8px; font-size:11px;">AIæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                    <button onclick="testProgressiveLearningAPI()" style="margin:5px; padding:3px 8px; font-size:11px;">æ®µéšçš„å­¦ç¿’APIãƒ†ã‚¹ãƒˆ</button>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/clike/clike.min.js"></script>
<script>
    // === å…ƒã®ã‚³ãƒ¼ãƒ‰è¨­å®šã‚’ãã®ã¾ã¾ä¿æŒ ===
    const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: "text/x-csrc",
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
    });
    const console = document.getElementById('console');
    const runButton = document.getElementById('runButton');
    const levelContent = document.getElementById('levelContent');
    
    // å…ƒã®å¤‰æ•°ã‚’ãã®ã¾ã¾ä¿æŒ
    let currentTaskId = null;
    let currentTaskDescription = '';
    let tasksData = {};
    
    // æ®µéšçš„å­¦ç¿’ç”¨ã®æ–°ã—ã„å¤‰æ•°
    let currentSessionId = null;
    let currentLearningPhase = null;
    
    // === å…ƒã®ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã‚’ãã®ã¾ã¾ä¿æŒ ===
    function safeLog(message, data = '') {
        try {
            if (typeof console !== 'undefined' && console.log) {
                console.log(message, data);
            }
        } catch (e) {
            // console ãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        }
    }
    
    function showDebugMessage(message) {
        const debugDiv = document.getElementById('debugMessage') || (() => {
            const div = document.createElement('div');
            div.id = 'debugMessage';
            div.style.cssText = 'position:fixed;top:10px;right:10px;background:#333;color:#fff;padding:10px;font-size:12px;max-width:300px;z-index:9999;border-radius:4px;';
            document.body.appendChild(div);
            return div;
        })();
        debugDiv.innerHTML = message + '<br>' + (debugDiv.innerHTML || '');
        setTimeout(() => debugDiv.style.display = 'none', 10000);
    }
    
    // === å…ƒã®ãƒ‡ãƒãƒƒã‚°é–¢æ•°ã‚’ãã®ã¾ã¾ä¿æŒ ===
    window.manualTestAPI = function() {
        safeLog('=== APIæ‰‹å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        showDebugMessage('ğŸ”§ APIæ‰‹å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        fetch('/api/tasks')
            .then(response => {
                safeLog('Response status:', response.status);
                safeLog('Response ok:', response.ok);
                showDebugMessage(`APIå¿œç­”: ${response.status} ${response.ok ? 'OK' : 'NG'}`);
                return response.json();
            })
            .then(data => {
                safeLog('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                const taskCount = data.tasks ? data.tasks.length : 0;
                showDebugMessage(`âœ… APIæ­£å¸¸: ${taskCount}å€‹ã®èª²é¡Œ`);
                alert(`APIå¿œç­”æ­£å¸¸: ${taskCount}å€‹ã®èª²é¡Œ`);
            })
            .catch(error => {
                safeLog('APIã‚¨ãƒ©ãƒ¼:', error);
                showDebugMessage(`âŒ APIã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert('APIã‚¨ãƒ©ãƒ¼: ' + error.message);
            });
    };
    
    window.showTasksData = function() {
        safeLog('=== tasksDataç¢ºèª ===');
        
        const currentTasksData = tasksData || window.tasksData;
        safeLog('tasksData:', currentTasksData);
        
        let message = '';
        if (currentTasksData && currentTasksData.tasks) {
            message = `tasksDataç¢ºèª: ${currentTasksData.tasks.length}å€‹ã®èª²é¡ŒãŒèª­ã¿è¾¼ã¿æ¸ˆã¿`;
            message += `\næœ€åˆã®5ã¤ã®èª²é¡Œ: ${currentTasksData.tasks.slice(0, 5).map(t => t.title).join(', ')}`;
            showDebugMessage(`âœ… ${message}`);
        } else if (currentTasksData) {
            message = 'tasksDataã¯å­˜åœ¨ã—ã¾ã™ãŒã€tasksãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“';
            message += `\nã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº«: ${Object.keys(currentTasksData).join(', ')}`;
            showDebugMessage(`âš ï¸ ${message}`);
        } else {
            message = 'tasksDataãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“';
            showDebugMessage(`âŒ ${message}`);
        }
        
        alert(message);
    };
    
    window.testOpenAI = function() {
        safeLog('=== OpenAIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        showDebugMessage('ğŸ¤– OpenAIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        fetch('/api/test-openai')
            .then(response => response.json())
            .then(data => {
                safeLog('OpenAI ãƒ†ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                if (data.status === 'success') {
                    showDebugMessage('âœ… OpenAIæ¥ç¶šæˆåŠŸ');
                    alert(`OpenAI APIæ¥ç¶šæˆåŠŸ!\n${data.message}`);
                } else {
                    showDebugMessage(`âŒ OpenAIæ¥ç¶šå¤±æ•—: ${data.message}`);
                    alert(`OpenAI APIæ¥ç¶šå¤±æ•—:\n${data.message}\nã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${data.error_type || 'Unknown'}`);
                }
            })
            .catch(error => {
                safeLog('OpenAI ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showDebugMessage(`âŒ OpenAIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                alert('OpenAIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            });
    };
    
    // æ–°ã—ã„ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã®ã¿è¿½åŠ 
    window.testProgressiveLearningAPI = function() {
        safeLog('=== æ®µéšçš„å­¦ç¿’APIãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
        showDebugMessage('ğŸ§ª æ®µéšçš„å­¦ç¿’APIãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        const testCode = `// ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ¼ãƒ‰
#include <stdio.h>
int main() {
    int n;
    scanf("%d", &n);
    // ã“ã“ã«å‡¦ç†ã‚’æ›¸ã
    return 0;
}`;
        
        fetch('/api/progressive-learning-analysis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                code: testCode,
                task_description: "æ•´æ•°nã‚’å…¥åŠ›ã—ã¦ã€1ã‹ã‚‰nã¾ã§ã®ç´„æ•°ã®ç·å’Œã‚’æ±‚ã‚ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚",
                session_id: "test_session"
            })
        })
        .then(response => response.json())
        .then(data => {
            safeLog('æ®µéšçš„å­¦ç¿’API ãƒ†ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
            if (data.success) {
                showDebugMessage(`âœ… æ®µéšçš„å­¦ç¿’APIæˆåŠŸ: ${data.detected_phase}`);
                alert(`æ®µéšçš„å­¦ç¿’APIæ¥ç¶šæˆåŠŸ!\nãƒ•ã‚§ãƒ¼ã‚º: ${data.detected_phase}\nåˆ†æçµæœ: ${JSON.stringify(data.analysis, null, 2).substring(0, 200)}...`);
            } else {
                showDebugMessage(`âŒ æ®µéšçš„å­¦ç¿’APIå¤±æ•—: ${data.message}`);
                alert(`æ®µéšçš„å­¦ç¿’APIå¤±æ•—:\n${data.message}\nã‚¨ãƒ©ãƒ¼: ${data.error || 'Unknown'}`);
            }
        })
        .catch(error => {
            safeLog('æ®µéšçš„å­¦ç¿’API ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            showDebugMessage(`âŒ æ®µéšçš„å­¦ç¿’APIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            alert('æ®µéšçš„å­¦ç¿’APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
        });
    };
    
    // === å…ƒã®ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œæ©Ÿèƒ½ã‚’ãã®ã¾ã¾ä¿æŒ ===
    runButton.addEventListener('click', async () => {
        const code = editor.getValue();
        console.textContent = 'å®Ÿè¡Œä¸­\n';

        try {
            const compileResponse = await fetch('https://wandbox.org/api/compile.json', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    code: code,
                    compiler: 'gcc-head',
                    options: '-std=c11',
                    stdin: ''
                })
            });
            
            const data = await compileResponse.json();
            
            if(data.compiler_error) {
                console.textContent = 'ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼\n' + data.compiler_error;
            } else if(data.program_error) {
                console.textContent = 'å®Ÿè¡Œæ™‚ã‚¨ãƒ©ãƒ¼\n' + data.program_error;
            } else {
                console.textContent = 'å®Ÿè¡Œçµæœ\n' + data.program_output;
            }
            
            showDebugMessage('âœ… ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œå®Œäº†');
        } catch (err) {
            console.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼\n';
            showDebugMessage('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
        }
    });
    
    // === å…ƒã®èª²é¡Œé–¢é€£æ©Ÿèƒ½ã‚’ãã®ã¾ã¾ä¿æŒ ===
    window.loadTasks = async function() {
        try {
            safeLog('èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...');
            showDebugMessage('ğŸ“¡ èª²é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
            
            const response = await fetch('/api/tasks');
            
            safeLog('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                safeLog('API Error:', errorText);
                showDebugMessage('âŒ API Error: ' + response.status);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            safeLog('å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);
            safeLog('èª²é¡Œæ•°:', data.tasks ? data.tasks.length : 'tasksãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            
            if (!data.tasks || !Array.isArray(data.tasks)) {
                showDebugMessage('âŒ ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼');
                throw new Error('APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœŸå¾…ã•ã‚Œã‚‹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
            }
            
            window.tasksData = data;
            tasksData = data;
            
            safeLog('tasksDataè¨­å®šå®Œäº†:', tasksData);
            showDebugMessage('ğŸ“‹ tasksDataè¨­å®š: ' + data.tasks.length + 'ä»¶');
            
            populateTaskSelect();
            safeLog('èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿å®Œäº†');
            showDebugMessage('âœ… èª²é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ' + data.tasks.length + 'ä»¶');
        } catch (error) {
            safeLog('èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error.message);
            showDebugMessage('âŒ èª²é¡Œãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message);
            
            document.getElementById('taskContent').innerHTML = `
                <div style="color:red; padding: 10px; border: 1px solid red; border-radius: 4px;">
                    <h3>âŒ èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h3>
                    <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
                    <details style="margin-top: 10px;">
                        <summary>è©³ç´°æƒ…å ±</summary>
                        <pre style="background: #f0f0f0; padding: 8px; margin-top: 5px; white-space: pre-wrap;">${error.stack || 'ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ãªã—'}</pre>
                    </details>
                    <button onclick="loadTasks()" style="margin-top: 10px; padding: 5px 10px;">ğŸ”„ å†èª­ã¿è¾¼ã¿</button>
                </div>
            `;
        }
    };
    
    function populateTaskSelect() {
        safeLog('populateTaskSelecté–‹å§‹');
        showDebugMessage('ğŸ“‹ ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ§‹ç¯‰é–‹å§‹');
        
        const taskSelect = document.getElementById('taskSelect');
        
        if (!taskSelect) {
            safeLog('taskSelectã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            showDebugMessage('âŒ taskSelectã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆãªã—');
            return;
        }
        
        const currentTasksData = tasksData || window.tasksData;
        
        if (!currentTasksData) {
            safeLog('tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            showDebugMessage('âŒ tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            taskSelect.innerHTML = '<option value="">èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</option>';
            return;
        }
        
        if (!currentTasksData.tasks || !Array.isArray(currentTasksData.tasks)) {
            safeLog('tasksData.tasksãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', currentTasksData);
            showDebugMessage('âŒ tasksData.tasksãŒç„¡åŠ¹');
            taskSelect.innerHTML = '<option value="">èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒç„¡åŠ¹</option>';
            return;
        }
        
        taskSelect.innerHTML = '<option value="">èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        let addedCount = 0;
        currentTasksData.tasks.forEach((task, index) => {
            if (task && task.id && task.title) {
                safeLog(`èª²é¡Œ${index + 1}ã‚’è¿½åŠ :`, task);
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.title;
                taskSelect.appendChild(option);
                addedCount++;
            } else {
                safeLog('ç„¡åŠ¹ãªèª²é¡Œãƒ‡ãƒ¼ã‚¿:', task);
            }
        });
        
        safeLog(`åˆè¨ˆ${addedCount}å€‹ã®èª²é¡Œã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¿½åŠ ã—ã¾ã—ãŸ`);
        showDebugMessage(`ğŸ“‹ ${addedCount}å€‹ã®èª²é¡Œã‚’ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«è¿½åŠ `);
        
        document.getElementById('taskContent').innerHTML = `
            <div style="color: green; padding: 10px;">
                âœ… ${addedCount}å€‹ã®èª²é¡ŒãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ<br>
                ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰èª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„
            </div>
        `;
    }
    
    function displayTask(taskId) {
        safeLog('displayTaskå‘¼ã³å‡ºã—:', taskId);
        showDebugMessage('ğŸ“ èª²é¡Œ' + taskId + 'è¡¨ç¤ºé–‹å§‹');
        
        const currentTasksData = tasksData || window.tasksData;
        
        if (!currentTasksData) {
            safeLog('tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“');
            showDebugMessage('âš ï¸ tasksDataãŒå­˜åœ¨ã—ã¾ã›ã‚“ - èª­ã¿è¾¼ã¿é–‹å§‹');
            document.getElementById('taskContent').innerHTML = `
                <div style="color:orange; padding: 10px;">
                    âš ï¸ èª²é¡Œãƒ‡ãƒ¼ã‚¿ãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“<br>
                    <button onclick="loadTasks()" style="margin-top: 5px;">èª²é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
                </div>
            `;
            window.loadTasks();
            return;
        }
        
        if (!currentTasksData.tasks || !Array.isArray(currentTasksData.tasks)) {
            safeLog('tasksData.tasksãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“:', currentTasksData);
            showDebugMessage('âš ï¸ tasksData.tasksãŒç„¡åŠ¹');
            document.getElementById('taskContent').innerHTML = `
                <div style="color:orange; padding: 10px;">
                    âš ï¸ èª²é¡Œãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒç„¡åŠ¹ã§ã™<br>
                    <button onclick="loadTasks()" style="margin-top: 5px;">å†èª­ã¿è¾¼ã¿</button>
                </div>
            `;
            return;
        }
        
        const task = currentTasksData.tasks.find(t => t.id == taskId);
        const taskContent = document.getElementById('taskContent');
        
        if (task) {
            currentTaskId = task.id;
            currentTaskDescription = task.description;
            
            taskContent.innerHTML = `
                <h3>${task.title}</h3>
                <p>${task.description}</p>
            `;
            safeLog('èª²é¡Œè¡¨ç¤ºå®Œäº†:', task.title);
            showDebugMessage(`âœ… èª²é¡Œ${taskId}è¡¨ç¤ºå®Œäº†`);
        } else {
            taskContent.innerHTML = `
                <div style="color:red; padding: 10px;">
                    âŒ èª²é¡Œ${taskId}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>
                    åˆ©ç”¨å¯èƒ½ãªèª²é¡Œ: 1ã€œ${currentTasksData.tasks.length}<br>
                    <small>åˆ©ç”¨å¯èƒ½ãªèª²é¡ŒID: ${currentTasksData.tasks.map(t => t.id).slice(0, 10).join(', ')}...</small>
                </div>
            `;
            currentTaskId = null;
            currentTaskDescription = '';
            safeLog('èª²é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', taskId);
            showDebugMessage(`âŒ èª²é¡Œ${taskId}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        }
    }
    
    // === æ®µéšçš„å­¦ç¿’æ”¯æ´ã®æ–°æ©Ÿèƒ½ã®ã¿è¿½åŠ  ===
    
    // é€²æ—è¡¨ç¤ºæ›´æ–°
    function updatePhaseProgress(phase, analysis) {
        const progressContainer = document.getElementById('phase-progress-container');
        const stageDetail = document.getElementById('stage-detail');
        const currentStageInfo = document.getElementById('current-stage-info');
        const completionFill = document.getElementById('completion-fill');
        const completionText = document.getElementById('completion-text');
        
        progressContainer.style.display = 'block';
        stageDetail.style.display = 'block';
        
        // ãƒ•ã‚§ãƒ¼ã‚ºã‚¹ãƒ†ãƒƒãƒ—ã®æ›´æ–°
        document.querySelectorAll('.phase-step').forEach(step => {
            step.className = 'phase-step pending';
        });
        
        let activePhaseElement;
        if (phase === 'phase1_understanding') {
            activePhaseElement = document.querySelector('[data-phase="phase1"]');
            currentStageInfo.innerHTML = `
                <strong>â‘  èª²é¡Œã®ç†è§£</strong><br>
                <small>${analysis.phase_name || 'èª²é¡Œã®ç†è§£'}</small>
            `;
        } else if (phase === 'phase2to4_conceptual_implementation') {
            activePhaseElement = document.querySelector('[data-phase="phase2to4"]');
            const stageNames = {
                'stage2_framework': 'â‘¡ å‡¦ç†ã®å¤§æ ',
                'stage3_details': 'â‘¢ å‡¦ç†ã®è©³ç´°åŒ–',
                'stage4_specifics': 'â‘£ æ¡ä»¶ãƒ»æ¼”ç®—ã®å…·ä½“åŒ–'
            };
            currentStageInfo.innerHTML = `
                <strong>â‘¡-â‘£ æ§‹æƒ³ãƒ»å®Ÿè£…</strong><br>
                <small>ç¾åœ¨: ${stageNames[analysis.current_stage] || analysis.current_stage_name}</small>
            `;
            document.querySelector('[data-phase="phase1"]').className = 'phase-step completed';
        } else if (phase === 'phase5_verification') {
            activePhaseElement = document.querySelector('[data-phase="phase5"]');
            currentStageInfo.innerHTML = `
                <strong>â‘¤ ã‚³ãƒ¼ãƒ‰ã®æ•´åˆæ€§åˆ¤å®š</strong><br>
                <small>${analysis.phase_name || 'æ¤œè¨¼'}</small>
            `;
            document.querySelector('[data-phase="phase1"]').className = 'phase-step completed';
            document.querySelector('[data-phase="phase2to4"]').className = 'phase-step completed';
        }
        
        if (activePhaseElement) {
            activePhaseElement.className = 'phase-step active';
        }
        
        const completionPercentage = analysis.completion_percentage || analysis.stage_completion_percentage || 0;
        completionFill.style.width = `${completionPercentage}%`;
        completionText.textContent = `${completionPercentage}% å®Œæˆ`;
    }
    
    // æ®µéšçš„å­¦ç¿’åˆ†æçµæœã®è¡¨ç¤º
    function displayProgressiveLearningAnalysis(result) {
        const analysis = result.analysis;
        const phase = result.detected_phase;
        
        currentLearningPhase = phase;
        updatePhaseProgress(phase, analysis);
        
        let content = `<div style="padding: 10px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <h3>${analysis.phase_name}</h3>`;
        
        if (phase === 'phase1_understanding') {
            content += displayPhase1Analysis(analysis);
        } else if (phase === 'phase2to4_conceptual_implementation') {
            content += displayPhase2to4Analysis(analysis);
        } else if (phase === 'phase5_verification') {
            content += displayPhase5Analysis(analysis);
        }
        
        content += `</div>`;
        levelContent.innerHTML = content;
    }
    
    // â‘  èª²é¡Œç†è§£ãƒ•ã‚§ãƒ¼ã‚ºã®è¡¨ç¤º
    function displayPhase1Analysis(analysis) {
        const understandingLevels = {
            'insufficient': 'âŒ ä¸ååˆ†',
            'partial': 'âš ï¸ éƒ¨åˆ†çš„',
            'good': 'âœ… è‰¯å¥½',
            'excellent': 'ğŸŒŸ å„ªç§€'
        };
        
        return `
            <div>ç†è§£åº¦: ${understandingLevels[analysis.understanding_level] || analysis.understanding_level}</div>
            <div>å®Œæˆåº¦: ${analysis.completion_percentage}%</div>
        </div>
        
        ${analysis.current_strengths && analysis.current_strengths.length > 0 ? `
        <div class="analysis-section strengths">
            <h4>ğŸ‘ ç¾åœ¨ã®ç†è§£ã§ãã¦ã„ã‚‹ç‚¹</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.current_strengths.map(s => `<li>${s}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.missing_understanding && analysis.missing_understanding.length > 0 ? `
        <div class="analysis-section improvements">
            <h4>ğŸ“‹ æ˜ç¢ºã«ã™ã¹ãç‚¹</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.missing_understanding.map(m => `<li>${m}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.clarification_questions && analysis.clarification_questions.length > 0 ? `
        <div class="analysis-section next-steps">
            <h4>â“ ç†è§£ã‚’æ·±ã‚ã‚‹è³ªå•</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.clarification_questions.map(q => `<li>${q}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        <div class="analysis-section next-steps">
            <h4>ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h4>
            <p style="margin: 0;">${analysis.next_step_guidance}</p>
        </div>
        
        <div class="analysis-section encouragement">
            <h4>ğŸŒŸ åŠ±ã¾ã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h4>
            <p style="margin: 0;"><strong>${analysis.encouragement}</strong></p>
        </div>
        `;
    }
    
    // â‘¡-â‘£ æ§‹æƒ³ãƒ»å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚ºã®è¡¨ç¤º
    function displayPhase2to4Analysis(analysis) {
        const stageNames = {
            'stage2_framework': 'â‘¡ å‡¦ç†ã®å¤§æ ã®æ±ºå®š',
            'stage3_details': 'â‘¢ å‡¦ç†ã®è©³ç´°åŒ–',
            'stage4_specifics': 'â‘£ æ¡ä»¶ãƒ»æ¼”ç®—ã®å…·ä½“åŒ–'
        };
        
        return `
            <div>ç¾åœ¨æ®µéš: ${stageNames[analysis.current_stage] || analysis.current_stage_name}</div>
            <div>æ®µéšå®Œæˆåº¦: ${analysis.stage_completion_percentage}%</div>
            <div>å…¨ä½“é€²æ—: ${analysis.overall_implementation_progress}%</div>
        </div>
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
            <h4>ğŸ“Š æ®µéšåˆ¥åˆ†æ</h4>
            <div style="font-size: 12px;">
                <div>â‘¡ å¤§æ : ${analysis.stage2_analysis.framework_completion}% 
                    ${analysis.stage2_analysis.has_top_level_comments ? 'âœ…ã‚³ãƒ¡ãƒ³ãƒˆ' : 'âŒã‚³ãƒ¡ãƒ³ãƒˆ'}
                    ${analysis.stage2_analysis.has_basic_structure ? 'âœ…æ§‹é€ ' : 'âŒæ§‹é€ '}
                </div>
                <div>â‘¢ è©³ç´°: ${analysis.stage3_analysis.details_completion}% 
                    ${analysis.stage3_analysis.has_variable_design ? 'âœ…å¤‰æ•°' : 'âŒå¤‰æ•°'}
                    ${analysis.stage3_analysis.has_control_structures ? 'âœ…åˆ¶å¾¡' : 'âŒåˆ¶å¾¡'}
                </div>
                <div>â‘£ å…·ä½“åŒ–: ${analysis.stage4_analysis.specifics_completion}% 
                    ${analysis.stage4_analysis.has_specific_conditions ? 'âœ…æ¡ä»¶' : 'âŒæ¡ä»¶'}
                    ${analysis.stage4_analysis.has_concrete_operations ? 'âœ…æ¼”ç®—' : 'âŒæ¼”ç®—'}
                </div>
            </div>
        </div>
        
        ${analysis.implemented_elements && analysis.implemented_elements.length > 0 ? `
        <div class="analysis-section strengths">
            <h4>âœ… å®Ÿè£…æ¸ˆã¿è¦ç´ </h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.implemented_elements.map(e => `<li>${e}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.missing_elements && analysis.missing_elements.length > 0 ? `
        <div class="analysis-section improvements">
            <h4>ğŸ”§ æœªå®Ÿè£…è¦ç´ </h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.missing_elements.map(e => `<li>${e}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        <div class="analysis-section next-steps">
            <h4>ğŸ¯ ç¾åœ¨ã®ç„¦ç‚¹</h4>
            <p style="margin: 0 0 10px 0;"><strong>${analysis.current_focus}</strong></p>
            
            <h4>ğŸ“ æ¬¡ã«ã‚„ã‚‹ã“ã¨</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.immediate_next_steps.map(step => `<li>${step}</li>`).join('')}
            </ul>
            
            ${analysis.why_these_steps ? `
            <div style="background: #e8f5e8; padding: 8px; border-radius: 4px; margin-top: 10px;">
                <strong>ğŸ’¡ ãªãœã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¿…è¦ï¼Ÿ</strong><br>
                ${analysis.why_these_steps}
            </div>
            ` : ''}
        </div>
        
        <div class="analysis-section encouragement">
            <h4>ğŸŒŸ åŠ±ã¾ã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h4>
            <p style="margin: 0;"><strong>${analysis.encouragement}</strong></p>
        </div>
        `;
    }
    
    // â‘¤ æ¤œè¨¼ãƒ•ã‚§ãƒ¼ã‚ºã®è¡¨ç¤º
    function displayPhase5Analysis(analysis) {
        return `
            <div>æ¤œè¨¼å®Œæˆåº¦: ${analysis.completion_percentage}%</div>
        </div>
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
            <h4>ğŸ” æ¤œè¨¼çµæœ</h4>
            <div style="font-size: 12px;">
                <div>${analysis.is_syntactically_correct ? 'âœ…' : 'âŒ'} æ§‹æ–‡ã®æ­£ç¢ºæ€§</div>
                <div>${analysis.is_logically_correct ? 'âœ…' : 'âŒ'} è«–ç†ã®æ­£ç¢ºæ€§</div>
                <div>${analysis.passes_basic_tests ? 'âœ…' : 'âŒ'} åŸºæœ¬ãƒ†ã‚¹ãƒˆé€šé</div>
                <div>${analysis.handles_edge_cases ? 'âœ…' : 'âŒ'} å¢ƒç•Œæ¡ä»¶å‡¦ç†</div>
            </div>
        </div>
        
        ${analysis.potential_issues && analysis.potential_issues.length > 0 ? `
        <div class="analysis-section improvements">
            <h4>âš ï¸ æ½œåœ¨çš„ãªå•é¡Œ</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.potential_issues.map(issue => `<li>${issue}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.debugging_steps && analysis.debugging_steps.length > 0 ? `
        <div class="analysis-section next-steps">
            <h4>ğŸ”§ ãƒ‡ãƒãƒƒã‚°æ‰‹é †</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.debugging_steps.map(step => `<li>${step}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        <div class="analysis-section next-steps">
            <h4>ğŸ“ å…¨ä½“è©•ä¾¡</h4>
            <p style="margin: 0;">${analysis.overall_assessment}</p>
        </div>
        
        <div class="analysis-section encouragement">
            <h4>ğŸŒŸ åŠ±ã¾ã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h4>
            <p style="margin: 0;"><strong>${analysis.encouragement}</strong></p>
        </div>
        `;
    }
    
    // === ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆå…ƒã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä¿æŒ + æ–°æ©Ÿèƒ½è¿½åŠ ï¼‰ ===
    document.addEventListener('DOMContentLoaded', () => {
        window.loadTasks();
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆï¼ˆæ–°æ©Ÿèƒ½ï¼‰
        currentSessionId = `session_${Date.now()}`;
        
        // === å…ƒã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ãã®ã¾ã¾ä¿æŒ ===
        document.getElementById('taskSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                displayTask(e.target.value);
                document.getElementById('taskNumber').value = e.target.value;
            }
        });
        
        // === æ–°ã—ã„AIæ®µéšçš„å­¦ç¿’æ”¯æ´ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ===
        const progressiveLearningButton = document.querySelector('.progressive-learning-button[data-task="0"]');
        if (progressiveLearningButton) {
            progressiveLearningButton.addEventListener('click', async () => {
                const code = editor.getValue();
                
                if (!currentTaskId || !currentTaskDescription) {
                    levelContent.innerHTML = '<div style="color:orange;">ã¾ãšèª²é¡Œã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                    showDebugMessage('âš ï¸ èª²é¡Œæœªé¸æŠ');
                    return;
                }
                
                if (!code.trim() || code.trim() === '//ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è¨˜è¿°') {
                    levelContent.innerHTML = '<div style="color:orange;">ã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¦ã‹ã‚‰AIæ®µéšçš„å­¦ç¿’æ”¯æ´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>';
                    showDebugMessage('âš ï¸ ã‚³ãƒ¼ãƒ‰æœªè¨˜è¿°');
                    return;
                }
                
                levelContent.innerHTML = `
                    <div style="text-align:center; padding: 20px;">
                        <div class="loading-spinner"></div>
                        <p>ğŸ¤– AIãŒæ®µéšçš„åˆ†æä¸­...</p>
                        <small>ã‚³ãƒ¼ãƒ‰ã®å­¦ç¿’æ®µéšã‚’åˆ¤å®šã—ã€é©åˆ‡ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æº–å‚™ã—ã¦ã„ã¾ã™</small>
                    </div>
                `;
                showDebugMessage('ğŸ¤– æ®µéšçš„å­¦ç¿’åˆ†æé–‹å§‹');
                
                try {
                    const analysisResponse = await fetch('/api/progressive-learning-analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            code: code,
                            task_description: currentTaskDescription,
                            session_id: currentSessionId
                        })
                    });
                    
                    const result = await analysisResponse.json();
                    
                    if (result.success) {
                        displayProgressiveLearningAnalysis(result);
                        showDebugMessage(`âœ… æ®µéšçš„å­¦ç¿’åˆ†æå®Œäº†: ${result.detected_phase}`);
                    } else {
                        levelContent.innerHTML = '<div style="color:red;">æ®µéšçš„å­¦ç¿’åˆ†æã‚¨ãƒ©ãƒ¼: ' + (result.error || 'Unknown error') + '</div>';
                        showDebugMessage('âŒ æ®µéšçš„å­¦ç¿’åˆ†æã‚¨ãƒ©ãƒ¼');
                    }
                } catch (error) {
                    levelContent.innerHTML = '<div style="color:red;">æ®µéšçš„å­¦ç¿’åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
                    showDebugMessage('âŒ æ®µéšçš„å­¦ç¿’åˆ†æã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            });
        }
    });
</script>
</body>
</html>