<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>段階的学習支援システム</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.css" />
<link rel="stylesheet" href="styles.css" />

<style>
/* 段階的学習用の追加スタイル */
.phase-progress {
    background: linear-gradient(90deg, #e3f2fd 0%, #bbdefb 100%);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    border: 2px solid #2196F3;
}

.phase-indicator {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.phase-step {
    flex: 1;
    text-align: center;
    padding: 8px;
    margin: 0 2px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.phase-step.active {
    background-color: #4CAF50;
    color: white;
    transform: scale(1.05);
}

.phase-step.completed {
    background-color: #2196F3;
    color: white;
}

.phase-step.pending {
    background-color: #f0f0f0;
    color: #666;
}

.stage-detail {
    background: white;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.completion-bar {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}

.completion-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    transition: width 0.5s ease;
}

.analysis-section {
    margin: 15px 0;
    padding: 12px;
    border-radius: 6px;
    border-left: 4px solid #2196F3;
}

.analysis-section h4 {
    margin: 0 0 8px 0;
    color: #1976D2;
}

.analysis-section.strengths {
    background-color: #e8f5e8;
    border-left-color: #4CAF50;
}

.analysis-section.improvements {
    background-color: #fff3e0;
    border-left-color: #FF9800;
}

.analysis-section.next-steps {
    background-color: #e3f2fd;
    border-left-color: #2196F3;
}

.analysis-section.encouragement {
    background-color: #f3e5f5;
    border-left-color: #9C27B0;
}

.progressive-learning-button {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    width: 100%;
    margin-bottom: 10px;
    transition: transform 0.2s ease;
}

.progressive-learning-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

</head>

<body>
<div id="container">
    <div id="leftContainer">
        <textarea id="editor">//コードをここに記述</textarea>

        <button id="runButton">コード実行</button>

        <div id="console"></div>
    </div>

    <div id="rightContainer">
        <!-- 元の課題選択部分をそのまま保持 -->
        <div id="taskContainer">
            <div id="taskButtons">
                <label for="taskSelect">課題選択:</label>
                <select id="taskSelect">
                    <option value="">課題を選択してください</option>
                </select>
            </div>

            <div id="taskContent">課題を選択してください</div>
        </div>

        <!-- 段階的学習進捗表示（新機能） -->
        <div id="phase-progress-container" class="phase-progress" style="display: none;">
            <div class="phase-indicator">
                <div class="phase-step pending" data-phase="phase1">
                    <div>①</div>
                    <div>課題理解</div>
                </div>
                <div class="phase-step pending" data-phase="phase2to4">
                    <div>②-④</div>
                    <div>構想・実装</div>
                </div>
                <div class="phase-step pending" data-phase="phase5">
                    <div>⑤</div>
                    <div>検証</div>
                </div>
            </div>
            
            <div id="stage-detail" class="stage-detail" style="display: none;">
                <div id="current-stage-info"></div>
                <div class="completion-bar">
                    <div id="completion-fill" class="completion-fill" style="width: 0%"></div>
                </div>
                <div id="completion-text">0% 完成</div>
            </div>
        </div>

        <!-- levelContainer は元のまま、ボタンのみ変更 -->
        <div id="levelContainer">
            <div id="levelButtons">
                <button class="progressive-learning-button" data-task="0">🤖 AI段階的学習支援 - コード分析</button>
            </div>
            <div id="levelContent">
            <div style="text-align:center; color:#666; padding:20px;">
                <p>📝 <strong>段階的学習支援システム</strong></p>
                <p>1. 課題を選択</p>
                <p>2. コードを記述</p>
                <p>3. AI段階的学習支援ボタンで分析を取得</p>
                <br>
                <p style="font-size:12px;">AIが学習段階を判定し、適切なガイダンスを提供します</p>
                <hr style="margin: 15px 0;">
                <div style="font-size:12px;">
                    <strong>🔧 デバッグ機能</strong><br>
                    <button onclick="manualTestAPI()" style="margin:5px; padding:3px 8px; font-size:11px;">API手動テスト</button>
                    <button onclick="showTasksData()" style="margin:5px; padding:3px 8px; font-size:11px;">データ確認</button>
                    <button onclick="testOpenAI()" style="margin:5px; padding:3px 8px; font-size:11px;">AI接続テスト</button>
                    <button onclick="testProgressiveLearningAPI()" style="margin:5px; padding:3px 8px; font-size:11px;">段階的学習APIテスト</button>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/clike/clike.min.js"></script>
<script>
    // === 元のコード設定をそのまま保持 ===
    const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        mode: "text/x-csrc",
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
    });
    const console = document.getElementById('console');
    const runButton = document.getElementById('runButton');
    const levelContent = document.getElementById('levelContent');
    
    // 元の変数をそのまま保持
    let currentTaskId = null;
    let currentTaskDescription = '';
    let tasksData = {};
    
    // 段階的学習用の新しい変数
    let currentSessionId = null;
    let currentLearningPhase = null;
    
    // === 元のデバッグ機能をそのまま保持 ===
    function safeLog(message, data = '') {
        try {
            if (typeof console !== 'undefined' && console.log) {
                console.log(message, data);
            }
        } catch (e) {
            // console が利用できない場合は何もしない
        }
    }
    
    function showDebugMessage(message) {
        const debugDiv = document.getElementById('debugMessage') || (() => {
            const div = document.createElement('div');
            div.id = 'debugMessage';
            div.style.cssText = 'position:fixed;top:10px;right:10px;background:#333;color:#fff;padding:10px;font-size:12px;max-width:300px;z-index:9999;border-radius:4px;';
            document.body.appendChild(div);
            return div;
        })();
        debugDiv.innerHTML = message + '<br>' + (debugDiv.innerHTML || '');
        setTimeout(() => debugDiv.style.display = 'none', 10000);
    }
    
    // === 元のデバッグ関数をそのまま保持 ===
    window.manualTestAPI = function() {
        safeLog('=== API手動テスト開始 ===');
        showDebugMessage('🔧 API手動テスト開始');
        
        fetch('/api/tasks')
            .then(response => {
                safeLog('Response status:', response.status);
                safeLog('Response ok:', response.ok);
                showDebugMessage(`API応答: ${response.status} ${response.ok ? 'OK' : 'NG'}`);
                return response.json();
            })
            .then(data => {
                safeLog('APIレスポンス:', data);
                const taskCount = data.tasks ? data.tasks.length : 0;
                showDebugMessage(`✅ API正常: ${taskCount}個の課題`);
                alert(`API応答正常: ${taskCount}個の課題`);
            })
            .catch(error => {
                safeLog('APIエラー:', error);
                showDebugMessage(`❌ APIエラー: ${error.message}`);
                alert('APIエラー: ' + error.message);
            });
    };
    
    window.showTasksData = function() {
        safeLog('=== tasksData確認 ===');
        
        const currentTasksData = tasksData || window.tasksData;
        safeLog('tasksData:', currentTasksData);
        
        let message = '';
        if (currentTasksData && currentTasksData.tasks) {
            message = `tasksData確認: ${currentTasksData.tasks.length}個の課題が読み込み済み`;
            message += `\n最初の5つの課題: ${currentTasksData.tasks.slice(0, 5).map(t => t.title).join(', ')}`;
            showDebugMessage(`✅ ${message}`);
        } else if (currentTasksData) {
            message = 'tasksDataは存在しますが、tasksプロパティがありません';
            message += `\nオブジェクトの中身: ${Object.keys(currentTasksData).join(', ')}`;
            showDebugMessage(`⚠️ ${message}`);
        } else {
            message = 'tasksDataが読み込まれていません';
            showDebugMessage(`❌ ${message}`);
        }
        
        alert(message);
    };
    
    window.testOpenAI = function() {
        safeLog('=== OpenAI接続テスト開始 ===');
        showDebugMessage('🤖 OpenAI接続テスト開始');
        
        fetch('/api/test-openai')
            .then(response => response.json())
            .then(data => {
                safeLog('OpenAI テストレスポンス:', data);
                if (data.status === 'success') {
                    showDebugMessage('✅ OpenAI接続成功');
                    alert(`OpenAI API接続成功!\n${data.message}`);
                } else {
                    showDebugMessage(`❌ OpenAI接続失敗: ${data.message}`);
                    alert(`OpenAI API接続失敗:\n${data.message}\nエラータイプ: ${data.error_type || 'Unknown'}`);
                }
            })
            .catch(error => {
                safeLog('OpenAI テストエラー:', error);
                showDebugMessage(`❌ OpenAIテストエラー: ${error.message}`);
                alert('OpenAI接続テストエラー: ' + error.message);
            });
    };
    
    // 新しいデバッグ機能のみ追加
    window.testProgressiveLearningAPI = function() {
        safeLog('=== 段階的学習APIテスト開始 ===');
        showDebugMessage('🧪 段階的学習APIテスト開始');
        
        const testCode = `// テスト用のコード
#include <stdio.h>
int main() {
    int n;
    scanf("%d", &n);
    // ここに処理を書く
    return 0;
}`;
        
        fetch('/api/progressive-learning-analysis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                code: testCode,
                task_description: "整数nを入力して、1からnまでの約数の総和を求めるプログラムを作成してください。",
                session_id: "test_session"
            })
        })
        .then(response => response.json())
        .then(data => {
            safeLog('段階的学習API テストレスポンス:', data);
            if (data.success) {
                showDebugMessage(`✅ 段階的学習API成功: ${data.detected_phase}`);
                alert(`段階的学習API接続成功!\nフェーズ: ${data.detected_phase}\n分析結果: ${JSON.stringify(data.analysis, null, 2).substring(0, 200)}...`);
            } else {
                showDebugMessage(`❌ 段階的学習API失敗: ${data.message}`);
                alert(`段階的学習API失敗:\n${data.message}\nエラー: ${data.error || 'Unknown'}`);
            }
        })
        .catch(error => {
            safeLog('段階的学習API テストエラー:', error);
            showDebugMessage(`❌ 段階的学習APIテストエラー: ${error.message}`);
            alert('段階的学習API接続テストエラー: ' + error.message);
        });
    };
    
    // === 元のコード実行機能をそのまま保持 ===
    runButton.addEventListener('click', async () => {
        const code = editor.getValue();
        console.textContent = '実行中\n';

        try {
            const compileResponse = await fetch('https://wandbox.org/api/compile.json', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    code: code,
                    compiler: 'gcc-head',
                    options: '-std=c11',
                    stdin: ''
                })
            });
            
            const data = await compileResponse.json();
            
            if(data.compiler_error) {
                console.textContent = 'コンパイルエラー\n' + data.compiler_error;
            } else if(data.program_error) {
                console.textContent = '実行時エラー\n' + data.program_error;
            } else {
                console.textContent = '実行結果\n' + data.program_output;
            }
            
            showDebugMessage('✅ コード実行完了');
        } catch (err) {
            console.textContent = 'ネットワークエラー\n';
            showDebugMessage('❌ ネットワークエラー');
        }
    });
    
    // === 元の課題関連機能をそのまま保持 ===
    window.loadTasks = async function() {
        try {
            safeLog('課題データの読み込みを開始...');
            showDebugMessage('📡 課題データ読み込み開始');
            
            const response = await fetch('/api/tasks');
            
            safeLog('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                safeLog('API Error:', errorText);
                showDebugMessage('❌ API Error: ' + response.status);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const data = await response.json();
            safeLog('受信したデータ:', data);
            safeLog('課題数:', data.tasks ? data.tasks.length : 'tasksプロパティが存在しません');
            
            if (!data.tasks || !Array.isArray(data.tasks)) {
                showDebugMessage('❌ データ形式エラー');
                throw new Error('APIレスポンスが期待される形式ではありません');
            }
            
            window.tasksData = data;
            tasksData = data;
            
            safeLog('tasksData設定完了:', tasksData);
            showDebugMessage('📋 tasksData設定: ' + data.tasks.length + '件');
            
            populateTaskSelect();
            safeLog('課題データの読み込み完了');
            showDebugMessage('✅ 課題データ読み込み完了: ' + data.tasks.length + '件');
        } catch (error) {
            safeLog('課題データの読み込みエラー:', error.message);
            showDebugMessage('❌ 課題データ読み込みエラー: ' + error.message);
            
            document.getElementById('taskContent').innerHTML = `
                <div style="color:red; padding: 10px; border: 1px solid red; border-radius: 4px;">
                    <h3>❌ 課題データの読み込みに失敗しました</h3>
                    <p><strong>エラー:</strong> ${error.message}</p>
                    <details style="margin-top: 10px;">
                        <summary>詳細情報</summary>
                        <pre style="background: #f0f0f0; padding: 8px; margin-top: 5px; white-space: pre-wrap;">${error.stack || 'スタックトレースなし'}</pre>
                    </details>
                    <button onclick="loadTasks()" style="margin-top: 10px; padding: 5px 10px;">🔄 再読み込み</button>
                </div>
            `;
        }
    };
    
    function populateTaskSelect() {
        safeLog('populateTaskSelect開始');
        showDebugMessage('📋 プルダウン構築開始');
        
        const taskSelect = document.getElementById('taskSelect');
        
        if (!taskSelect) {
            safeLog('taskSelectエレメントが見つかりません');
            showDebugMessage('❌ taskSelectエレメントなし');
            return;
        }
        
        const currentTasksData = tasksData || window.tasksData;
        
        if (!currentTasksData) {
            safeLog('tasksDataが存在しません');
            showDebugMessage('❌ tasksDataが存在しません');
            taskSelect.innerHTML = '<option value="">課題データを読み込み中...</option>';
            return;
        }
        
        if (!currentTasksData.tasks || !Array.isArray(currentTasksData.tasks)) {
            safeLog('tasksData.tasksが配列ではありません:', currentTasksData);
            showDebugMessage('❌ tasksData.tasksが無効');
            taskSelect.innerHTML = '<option value="">課題データの形式が無効</option>';
            return;
        }
        
        taskSelect.innerHTML = '<option value="">課題を選択してください</option>';
        
        let addedCount = 0;
        currentTasksData.tasks.forEach((task, index) => {
            if (task && task.id && task.title) {
                safeLog(`課題${index + 1}を追加:`, task);
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = task.title;
                taskSelect.appendChild(option);
                addedCount++;
            } else {
                safeLog('無効な課題データ:', task);
            }
        });
        
        safeLog(`合計${addedCount}個の課題をプルダウンに追加しました`);
        showDebugMessage(`📋 ${addedCount}個の課題をプルダウンに追加`);
        
        document.getElementById('taskContent').innerHTML = `
            <div style="color: green; padding: 10px;">
                ✅ ${addedCount}個の課題が正常に読み込まれました<br>
                プルダウンメニューから課題を選択してください
            </div>
        `;
    }
    
    function displayTask(taskId) {
        safeLog('displayTask呼び出し:', taskId);
        showDebugMessage('📝 課題' + taskId + '表示開始');
        
        const currentTasksData = tasksData || window.tasksData;
        
        if (!currentTasksData) {
            safeLog('tasksDataが存在しません');
            showDebugMessage('⚠️ tasksDataが存在しません - 読み込み開始');
            document.getElementById('taskContent').innerHTML = `
                <div style="color:orange; padding: 10px;">
                    ⚠️ 課題データがまだ読み込まれていません<br>
                    <button onclick="loadTasks()" style="margin-top: 5px;">課題データを読み込む</button>
                </div>
            `;
            window.loadTasks();
            return;
        }
        
        if (!currentTasksData.tasks || !Array.isArray(currentTasksData.tasks)) {
            safeLog('tasksData.tasksが配列ではありません:', currentTasksData);
            showDebugMessage('⚠️ tasksData.tasksが無効');
            document.getElementById('taskContent').innerHTML = `
                <div style="color:orange; padding: 10px;">
                    ⚠️ 課題データの形式が無効です<br>
                    <button onclick="loadTasks()" style="margin-top: 5px;">再読み込み</button>
                </div>
            `;
            return;
        }
        
        const task = currentTasksData.tasks.find(t => t.id == taskId);
        const taskContent = document.getElementById('taskContent');
        
        if (task) {
            currentTaskId = task.id;
            currentTaskDescription = task.description;
            
            taskContent.innerHTML = `
                <h3>${task.title}</h3>
                <p>${task.description}</p>
            `;
            safeLog('課題表示完了:', task.title);
            showDebugMessage(`✅ 課題${taskId}表示完了`);
        } else {
            taskContent.innerHTML = `
                <div style="color:red; padding: 10px;">
                    ❌ 課題${taskId}が見つかりません<br>
                    利用可能な課題: 1〜${currentTasksData.tasks.length}<br>
                    <small>利用可能な課題ID: ${currentTasksData.tasks.map(t => t.id).slice(0, 10).join(', ')}...</small>
                </div>
            `;
            currentTaskId = null;
            currentTaskDescription = '';
            safeLog('課題が見つかりません:', taskId);
            showDebugMessage(`❌ 課題${taskId}が見つかりません`);
        }
    }
    
    // === 段階的学習支援の新機能のみ追加 ===
    
    // 進捗表示更新
    function updatePhaseProgress(phase, analysis) {
        const progressContainer = document.getElementById('phase-progress-container');
        const stageDetail = document.getElementById('stage-detail');
        const currentStageInfo = document.getElementById('current-stage-info');
        const completionFill = document.getElementById('completion-fill');
        const completionText = document.getElementById('completion-text');
        
        progressContainer.style.display = 'block';
        stageDetail.style.display = 'block';
        
        // フェーズステップの更新
        document.querySelectorAll('.phase-step').forEach(step => {
            step.className = 'phase-step pending';
        });
        
        let activePhaseElement;
        if (phase === 'phase1_understanding') {
            activePhaseElement = document.querySelector('[data-phase="phase1"]');
            currentStageInfo.innerHTML = `
                <strong>① 課題の理解</strong><br>
                <small>${analysis.phase_name || '課題の理解'}</small>
            `;
        } else if (phase === 'phase2to4_conceptual_implementation') {
            activePhaseElement = document.querySelector('[data-phase="phase2to4"]');
            const stageNames = {
                'stage2_framework': '② 処理の大枠',
                'stage3_details': '③ 処理の詳細化',
                'stage4_specifics': '④ 条件・演算の具体化'
            };
            currentStageInfo.innerHTML = `
                <strong>②-④ 構想・実装</strong><br>
                <small>現在: ${stageNames[analysis.current_stage] || analysis.current_stage_name}</small>
            `;
            document.querySelector('[data-phase="phase1"]').className = 'phase-step completed';
        } else if (phase === 'phase5_verification') {
            activePhaseElement = document.querySelector('[data-phase="phase5"]');
            currentStageInfo.innerHTML = `
                <strong>⑤ コードの整合性判定</strong><br>
                <small>${analysis.phase_name || '検証'}</small>
            `;
            document.querySelector('[data-phase="phase1"]').className = 'phase-step completed';
            document.querySelector('[data-phase="phase2to4"]').className = 'phase-step completed';
        }
        
        if (activePhaseElement) {
            activePhaseElement.className = 'phase-step active';
        }
        
        const completionPercentage = analysis.completion_percentage || analysis.stage_completion_percentage || 0;
        completionFill.style.width = `${completionPercentage}%`;
        completionText.textContent = `${completionPercentage}% 完成`;
    }
    
    // 段階的学習分析結果の表示
    function displayProgressiveLearningAnalysis(result) {
        const analysis = result.analysis;
        const phase = result.detected_phase;
        
        currentLearningPhase = phase;
        updatePhaseProgress(phase, analysis);
        
        let content = `<div style="padding: 10px;">
            <div style="text-align: center; margin-bottom: 15px;">
                <h3>${analysis.phase_name}</h3>`;
        
        if (phase === 'phase1_understanding') {
            content += displayPhase1Analysis(analysis);
        } else if (phase === 'phase2to4_conceptual_implementation') {
            content += displayPhase2to4Analysis(analysis);
        } else if (phase === 'phase5_verification') {
            content += displayPhase5Analysis(analysis);
        }
        
        content += `</div>`;
        levelContent.innerHTML = content;
    }
    
    // ① 課題理解フェーズの表示
    function displayPhase1Analysis(analysis) {
        const understandingLevels = {
            'insufficient': '❌ 不十分',
            'partial': '⚠️ 部分的',
            'good': '✅ 良好',
            'excellent': '🌟 優秀'
        };
        
        return `
            <div>理解度: ${understandingLevels[analysis.understanding_level] || analysis.understanding_level}</div>
            <div>完成度: ${analysis.completion_percentage}%</div>
        </div>
        
        ${analysis.current_strengths && analysis.current_strengths.length > 0 ? `
        <div class="analysis-section strengths">
            <h4>👍 現在の理解できている点</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.current_strengths.map(s => `<li>${s}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.missing_understanding && analysis.missing_understanding.length > 0 ? `
        <div class="analysis-section improvements">
            <h4>📋 明確にすべき点</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.missing_understanding.map(m => `<li>${m}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.clarification_questions && analysis.clarification_questions.length > 0 ? `
        <div class="analysis-section next-steps">
            <h4>❓ 理解を深める質問</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.clarification_questions.map(q => `<li>${q}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        <div class="analysis-section next-steps">
            <h4>🎯 次のステップ</h4>
            <p style="margin: 0;">${analysis.next_step_guidance}</p>
        </div>
        
        <div class="analysis-section encouragement">
            <h4>🌟 励ましのメッセージ</h4>
            <p style="margin: 0;"><strong>${analysis.encouragement}</strong></p>
        </div>
        `;
    }
    
    // ②-④ 構想・実装フェーズの表示
    function displayPhase2to4Analysis(analysis) {
        const stageNames = {
            'stage2_framework': '② 処理の大枠の決定',
            'stage3_details': '③ 処理の詳細化',
            'stage4_specifics': '④ 条件・演算の具体化'
        };
        
        return `
            <div>現在段階: ${stageNames[analysis.current_stage] || analysis.current_stage_name}</div>
            <div>段階完成度: ${analysis.stage_completion_percentage}%</div>
            <div>全体進捗: ${analysis.overall_implementation_progress}%</div>
        </div>
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
            <h4>📊 段階別分析</h4>
            <div style="font-size: 12px;">
                <div>② 大枠: ${analysis.stage2_analysis.framework_completion}% 
                    ${analysis.stage2_analysis.has_top_level_comments ? '✅コメント' : '❌コメント'}
                    ${analysis.stage2_analysis.has_basic_structure ? '✅構造' : '❌構造'}
                </div>
                <div>③ 詳細: ${analysis.stage3_analysis.details_completion}% 
                    ${analysis.stage3_analysis.has_variable_design ? '✅変数' : '❌変数'}
                    ${analysis.stage3_analysis.has_control_structures ? '✅制御' : '❌制御'}
                </div>
                <div>④ 具体化: ${analysis.stage4_analysis.specifics_completion}% 
                    ${analysis.stage4_analysis.has_specific_conditions ? '✅条件' : '❌条件'}
                    ${analysis.stage4_analysis.has_concrete_operations ? '✅演算' : '❌演算'}
                </div>
            </div>
        </div>
        
        ${analysis.implemented_elements && analysis.implemented_elements.length > 0 ? `
        <div class="analysis-section strengths">
            <h4>✅ 実装済み要素</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.implemented_elements.map(e => `<li>${e}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.missing_elements && analysis.missing_elements.length > 0 ? `
        <div class="analysis-section improvements">
            <h4>🔧 未実装要素</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.missing_elements.map(e => `<li>${e}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        <div class="analysis-section next-steps">
            <h4>🎯 現在の焦点</h4>
            <p style="margin: 0 0 10px 0;"><strong>${analysis.current_focus}</strong></p>
            
            <h4>📝 次にやること</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.immediate_next_steps.map(step => `<li>${step}</li>`).join('')}
            </ul>
            
            ${analysis.why_these_steps ? `
            <div style="background: #e8f5e8; padding: 8px; border-radius: 4px; margin-top: 10px;">
                <strong>💡 なぜこのステップが必要？</strong><br>
                ${analysis.why_these_steps}
            </div>
            ` : ''}
        </div>
        
        <div class="analysis-section encouragement">
            <h4>🌟 励ましのメッセージ</h4>
            <p style="margin: 0;"><strong>${analysis.encouragement}</strong></p>
        </div>
        `;
    }
    
    // ⑤ 検証フェーズの表示
    function displayPhase5Analysis(analysis) {
        return `
            <div>検証完成度: ${analysis.completion_percentage}%</div>
        </div>
        
        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0;">
            <h4>🔍 検証結果</h4>
            <div style="font-size: 12px;">
                <div>${analysis.is_syntactically_correct ? '✅' : '❌'} 構文の正確性</div>
                <div>${analysis.is_logically_correct ? '✅' : '❌'} 論理の正確性</div>
                <div>${analysis.passes_basic_tests ? '✅' : '❌'} 基本テスト通過</div>
                <div>${analysis.handles_edge_cases ? '✅' : '❌'} 境界条件処理</div>
            </div>
        </div>
        
        ${analysis.potential_issues && analysis.potential_issues.length > 0 ? `
        <div class="analysis-section improvements">
            <h4>⚠️ 潜在的な問題</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.potential_issues.map(issue => `<li>${issue}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${analysis.debugging_steps && analysis.debugging_steps.length > 0 ? `
        <div class="analysis-section next-steps">
            <h4>🔧 デバッグ手順</h4>
            <ul style="margin: 0; padding-left: 20px;">
                ${analysis.debugging_steps.map(step => `<li>${step}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        <div class="analysis-section next-steps">
            <h4>📝 全体評価</h4>
            <p style="margin: 0;">${analysis.overall_assessment}</p>
        </div>
        
        <div class="analysis-section encouragement">
            <h4>🌟 励ましのメッセージ</h4>
            <p style="margin: 0;"><strong>${analysis.encouragement}</strong></p>
        </div>
        `;
    }
    
    // === イベントリスナー設定（元のものをそのまま保持 + 新機能追加） ===
    document.addEventListener('DOMContentLoaded', () => {
        window.loadTasks();
        
        // セッションID生成（新機能）
        currentSessionId = `session_${Date.now()}`;
        
        // === 元のイベントリスナーをそのまま保持 ===
        document.getElementById('taskSelect').addEventListener('change', (e) => {
            if (e.target.value) {
                displayTask(e.target.value);
                document.getElementById('taskNumber').value = e.target.value;
            }
        });
        
        // === 新しいAI段階的学習支援ボタンのイベントリスナー ===
        const progressiveLearningButton = document.querySelector('.progressive-learning-button[data-task="0"]');
        if (progressiveLearningButton) {
            progressiveLearningButton.addEventListener('click', async () => {
                const code = editor.getValue();
                
                if (!currentTaskId || !currentTaskDescription) {
                    levelContent.innerHTML = '<div style="color:orange;">まず課題を選択してください</div>';
                    showDebugMessage('⚠️ 課題未選択');
                    return;
                }
                
                if (!code.trim() || code.trim() === '//コードをここに記述') {
                    levelContent.innerHTML = '<div style="color:orange;">コードを記述してからAI段階的学習支援をクリックしてください</div>';
                    showDebugMessage('⚠️ コード未記述');
                    return;
                }
                
                levelContent.innerHTML = `
                    <div style="text-align:center; padding: 20px;">
                        <div class="loading-spinner"></div>
                        <p>🤖 AIが段階的分析中...</p>
                        <small>コードの学習段階を判定し、適切なガイダンスを準備しています</small>
                    </div>
                `;
                showDebugMessage('🤖 段階的学習分析開始');
                
                try {
                    const analysisResponse = await fetch('/api/progressive-learning-analysis', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            code: code,
                            task_description: currentTaskDescription,
                            session_id: currentSessionId
                        })
                    });
                    
                    const result = await analysisResponse.json();
                    
                    if (result.success) {
                        displayProgressiveLearningAnalysis(result);
                        showDebugMessage(`✅ 段階的学習分析完了: ${result.detected_phase}`);
                    } else {
                        levelContent.innerHTML = '<div style="color:red;">段階的学習分析エラー: ' + (result.error || 'Unknown error') + '</div>';
                        showDebugMessage('❌ 段階的学習分析エラー');
                    }
                } catch (error) {
                    levelContent.innerHTML = '<div style="color:red;">段階的学習分析エラー: ' + error.message + '</div>';
                    showDebugMessage('❌ 段階的学習分析エラー: ' + error.message);
                }
            });
        }
    });
</script>
</body>
</html>